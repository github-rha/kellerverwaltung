# Plan: v0.6.1 — Country field

## Goal

Add an optional `country` field to every wine entry. Users pick from a fixed list of
wine-producing countries on the add/edit form. Existing entries migrate silently to `country: ""`.
Country is included in CSV import and can be filtered on the dashboard.

---

## Data model

### `WineEntry` (types.ts)

Add `country: string` — always present, empty string means unset.

### Schema (`schema/cellar.schema.json`)

Add `country` to `required` and `properties`:

```json
"country": { "type": "string" }
```

`additionalProperties: false` is already in effect — the field must be declared.

### Migration (`persist.ts` — `loadCellar`)

Old entries stored without `country` will fail schema validation when the app next
mutates the cellar. To prevent this, `loadCellar` fills in `country: ""` for any entry
missing the field after reading from IndexedDB. This runs transparently on first load.

---

## Country list (`app/src/lib/data/countries.ts`)

New file exporting a single sorted string array `COUNTRIES: string[]` of ~50
wine-producing countries. Used by the form select and for normalising CSV values.

Representative list (alphabetical):
Algeria, Argentina, Armenia, Australia, Austria, Brazil, Bulgaria, Canada, Chile, China,
Croatia, Cyprus, Czech Republic, France, Georgia, Germany, Greece, Hungary, India, Israel,
Italy, Japan, Jordan, Lebanon, Luxembourg, Mexico, Moldova, Montenegro, Morocco, New Zealand,
North Macedonia, Peru, Portugal, Romania, Russia, Serbia, Slovakia, Slovenia, South Africa,
Spain, Switzerland, Tunisia, Turkey, Ukraine, United Kingdom, United States, Uruguay

---

## Changed files

### `app/src/lib/data/types.ts`
Add `country: string` to `WineEntry`.

### `app/src/lib/data/persist.ts`
In `loadCellar`, after reading data, migrate:
```ts
for (const w of data.wines) {
  if (!('country' in w)) (w as WineEntry).country = ''
}
```

### `app/src/lib/data/store.ts`
- Add `country: string` to `CreateWineInput`
- Pass `country` through in `createWine`

### `app/src/lib/data/filter-sort.ts`
Add `filterByCountry(wines, country: string | null): WineEntry[]`.

### `app/src/lib/data/csv.ts`
- Optional `country` column: absent or empty → `''`, otherwise store trimmed raw value
- Add `country` to `ImportEntry`

### `app/src/lib/components/WineForm.svelte`
- Add `country = $bindable()` prop (string)
- Add `<select id="wine-country">` below the type select, populated from `COUNTRIES`
- First option: `<option value="">— Not specified —</option>`

### `app/src/routes/wine/new/+page.svelte`
- Add `let country = $state('')`
- Pass `bind:country` to `WineForm`
- Pass `country` to `createWine`

### `app/src/routes/wine/[id]/+page.svelte`
- Add `let editCountry = $state('')`
- Populate from `wine.country` in `startEdit()`
- Pass `bind:country={editCountry}` to `WineForm`
- Pass `country: editCountry.trim()` in `updateWine`
- Show `country` in view mode (below producer/vintage line, only when non-empty)

### `app/src/routes/+page.svelte`
- Add `let activeCountry: string | null = $state(null)`
- Read `?country=` query param in `onMount`
- Add `filterByCountry` to the filter chain
- Country filter section in the filter dropdown (list of countries present in cellar)
- Country chip in active-filter row
- Deep-link: `?country=France`

### `schema/examples/cellar.json`
Add `"country": "Germany"` / `"France"` to existing example entries.

### `schema/examples/empty.json`
No change needed (no wine entries).

---

## Tests

### `app/src/lib/data/persist.test.ts`
- Migration: loading old cellar data without `country` populates `country: ""`

### `app/src/lib/data/filter-sort.test.ts`
- `filterByCountry` returns only wines matching country
- `filterByCountry` returns all when null

### `app/src/lib/data/csv.test.ts`
- `country` column absent → `entry.country === ""`
- `country` column present with value → stored trimmed
- `country` column present but empty → `""`

### `app/src/lib/data/store.test.ts` / `import.test.ts`
Update `sampleInput` and `makeEntry` helpers to include `country: ''`.

### `app/src/lib/data/filter-sort.test.ts`
Update `makeWine` helper to include `country: ''`.

---

## Acceptance criteria

- [ ] Existing cellar (no `country` field) loads and works without any error
- [ ] Add wine form has a country dropdown; submitting with no selection stores `""`
- [ ] Edit form pre-fills country from stored value
- [ ] Country shown on wine detail when non-empty
- [ ] Dashboard filter by country works; `?country=` query param deep-links
- [ ] CSV import: `country` column optional; absent/empty → `""`; value stored as-is
- [ ] Schema example validates against updated schema
- [ ] `npm run lint`, `npm run check`, `npm test` pass
