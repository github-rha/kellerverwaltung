# v0.5.0 — CI pipeline

## Context

v0.4.0 shipped GitHub sync. The app now needs automated quality gates and
auto-deploy to `kellerverwaltung.haeusler-wein.ch` via GitHub Pages.

## Prerequisites (manual, one-time)

These must be done before the first successful deploy:

1. **DNS** — add a CNAME record at your DNS provider:
   `kellerverwaltung.haeusler-wein.ch → github-rha.github.io`

2. **GitHub repo → Settings → Pages**:
   - Source: **GitHub Actions**
   - Custom domain: `kellerverwaltung.haeusler-wein.ch`
   - Tick **Enforce HTTPS** once the DNS record has propagated

## Approach

Two-job GitHub Actions workflow:

- **`ci`** — lint, type-check, schema validation, unit/integration tests, build,
  E2E tests (Playwright WebKit). On push to `main`, also uploads the Pages
  artifact.
- **`deploy`** — deploys the Pages artifact. Only runs on push to `main`.

No new runtime dependencies. Playwright is dev-only.

---

## Steps

### 1. CNAME file

**New file:** `app/static/CNAME`

Single line: `kellerverwaltung.haeusler-wein.ch`

Copied verbatim into `app/build/` by the static adapter, telling GitHub Pages
which custom domain to serve.

### 2. Schema validation script and examples

**New file:** `app/scripts/validate-schema.mjs`

Uses AJV (already a project dependency) to validate all files in
`schema/examples/` against `schema/cellar.schema.json`. Exits 1 on failure.

**New file:** `schema/examples/empty.json`

```json
{ "schemaVersion": 1, "wines": [] }
```

**New file:** `schema/examples/sample.json`

A minimal one-wine cellar covering all required fields (no photoRef, NV vintage
for variety).

**Add to `app/package.json` scripts:**

```json
"validate:schema": "node scripts/validate-schema.mjs"
```

### 3. Playwright setup

**Install (dev dependency in `app/`):**

```
@playwright/test
```

**New file:** `app/playwright.config.ts`

- Project: WebKit only
- `baseURL`: `http://localhost:4173`
- `webServer`: `npm run preview`, port 4173, `reuseExistingServer: !process.env.CI`
- Timeout: 30s per test
- Test directory: `app/tests/`

**Add to `app/package.json` scripts:**

```json
"test:e2e": "playwright test"
```

### 4. E2E smoke tests

**New file:** `app/tests/smoke.test.ts`

Four tests — only what unit/integration tests cannot cover:

| Test | What it verifies |
|------|-----------------|
| Dashboard loads | Page title "Kellerverwaltung" visible; shows "0 bottles total" |
| Add wine → appears on dashboard | Fill form (`#wine-producer`, `#wine-name`, `#wine-vintage`, `#wine-bottles`), submit, wine row visible, total count updated |
| +1 on wine detail | Navigate to detail, tap +1, bottle count increments |
| Edit wine → save → changes visible | Enter edit mode, change name, save, updated name shown |

Each test uses a fresh browser context (default Playwright behaviour) so
IndexedDB is empty at the start of every test.

### 5. GitHub Actions workflow

**New file:** `.github/workflows/ci.yml`

```
on:
  push: branches [main]
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - checkout
      - setup-node (22, npm cache keyed on app/package-lock.json)
      - npm ci  (working-directory: app)
      - npm run lint
      - npm run check
      - npm run validate:schema
      - npm test
      - npm run build
      - cache Playwright browsers
      - npx playwright install webkit --with-deps
      - npm run test:e2e
      - actions/upload-pages-artifact  (path: app/build)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'

  deploy:
    needs: ci
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - actions/deploy-pages
```

Playwright browser cache key: `playwright-webkit-${{ runner.os }}-${{ hashFiles('app/package-lock.json') }}`

---

## Files to create / modify

| File | Action |
|------|--------|
| `app/static/CNAME` | Create |
| `app/scripts/validate-schema.mjs` | Create |
| `schema/examples/empty.json` | Create |
| `schema/examples/sample.json` | Create |
| `app/playwright.config.ts` | Create |
| `app/tests/smoke.test.ts` | Create |
| `.github/workflows/ci.yml` | Create |
| `app/package.json` | Add `validate:schema`, `test:e2e` scripts; add `@playwright/test` dev dep |
| `docs/roadmap.md` | Mark v0.5.0 complete |
| `CHANGELOG.md` | Add v0.5.0 entry |
| `app/package.json` | Bump to 0.5.0 |

---

## Verification

1. Push to `main` → Actions tab shows green `ci` + `deploy` jobs
2. `https://kellerverwaltung.haeusler-wein.ch` loads the app
3. HTTPS certificate issued (may take a few minutes after first deploy)
4. PR branch → `ci` job runs and passes; `deploy` is skipped
