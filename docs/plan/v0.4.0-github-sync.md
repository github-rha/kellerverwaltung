# v0.4.0 — GitHub sync

## Context

v0.3.0 shipped photo capture. The architecture already describes the sync protocol
in full (push/pull/force-pull, PAT storage, GitHub Contents API). This milestone
makes sync real: a Settings view for repo + PAT, manual push and pull on the
dashboard, conflict-avoidance (block pull when unsynced), and a force-pull escape
hatch.

## Approach

No new dependencies. All GitHub API calls go through `fetch` directly — the
Contents API is simple enough. Photos are base64-encoded for transport. The sync
engine lives in a new `sync.ts` module. A writable store tracks whether local
data is unsynced so the dashboard can react to it.

---

## Steps

### 1. Settings persistence

**New file:** `app/src/lib/data/settings.ts`

```typescript
export interface SyncSettings {
  repo: string  // "owner/repo"
  pat: string
}

export function isConfigured(s: SyncSettings): boolean
export async function loadSettings(): Promise<SyncSettings>
export async function saveSettings(s: SyncSettings): Promise<void>
```

Stores `repo` and `pat` under separate idb-keyval keys
(`kellerverwaltung-settings-repo`, `kellerverwaltung-settings-pat`).
`loadSettings()` returns `{ repo: '', pat: '' }` when nothing is stored.

**New file:** `app/src/lib/data/settings.test.ts`

| Test | What it verifies |
|------|-----------------|
| `loadSettings` returns empty strings when nothing stored | Default state |
| `saveSettings` + `loadSettings` roundtrips repo and PAT | Persistence |
| `isConfigured` returns false when repo is empty | Guard condition |
| `isConfigured` returns false when PAT is empty | Guard condition |
| `isConfigured` returns true when both are set | Happy path |

### 2. Unsynced-changes tracking

**Modify:** `app/src/lib/data/persist.ts`

Add a boolean `kellerverwaltung-unsynced` key to IndexedDB:

- `saveCellar()` also writes `true` to this key and sets the exported
  `unsyncedStore` writable.
- New `markSynced()` writes `false` and updates the store.
- New `loadSyncState()` reads the key and syncs the writable — called by
  `initStore()`.

```typescript
export const unsyncedStore: Writable<boolean>  // exported for dashboard
export async function markSynced(): Promise<void>
export async function loadSyncState(): Promise<void>
```

**Modify:** `app/src/lib/data/store.ts`

Call `loadSyncState()` inside `initStore()`.

### 3. Sync engine

**New file:** `app/src/lib/data/sync.ts`

#### GitHub API helpers (internal)

All requests use headers:
```
Authorization: Bearer {pat}
Accept: application/vnd.github+json
X-GitHub-Api-Version: 2022-11-28
```

Base URL pattern: `https://api.github.com/repos/{owner}/{repo}/contents/{path}`

- `getFileSha(repo, pat, path): Promise<string | null>` — GET the path; return
  `sha` if 200, `null` if 404, throw on other errors.
- `putFile(repo, pat, path, content: ArrayBuffer, sha: string | null, message: string): Promise<void>` —
  PUT with base64-encoded content; omit `sha` field when `null` (first upload).
- `getFileContent(repo, pat, path): Promise<ArrayBuffer | null>` — GET path,
  decode base64 content to `ArrayBuffer`; return `null` if 404.

Base64 helpers (internal, not exported):
- Encode text to base64 via `TextEncoder` → `btoa`.
- Decode base64 to text via `atob` → `TextDecoder` (strip embedded newlines GitHub adds).
- Encode/decode binary `ArrayBuffer` via `Uint8Array` ↔ `btoa`/`atob`.

#### Public API

```typescript
export class SyncError extends Error {}  // for typed error handling in UI

export async function push(settings: SyncSettings): Promise<void>
export async function pull(settings: SyncSettings): Promise<void>
export async function forcePull(settings: SyncSettings): Promise<void>
```

**`push()` logic:**

1. Load cellar from IndexedDB.
2. For each wine with non-empty `photoRef`, load the photo from IndexedDB.
3. For each photo: `getFileSha` → `putFile` at `data/photos/<id>.avif`.
4. `getFileSha` for `data/cellar.json` → `putFile` with JSON content.
5. `markSynced()`.

**`pull()` logic:**

1. Read `unsyncedStore` — if `true`, throw `SyncError('unsynced')`.
2. Call `_pull(settings)`.

**`forcePull()` logic:**

1. Call `_pull(settings)` directly (no guard).

**`_pull()` (internal):**

1. `getFileContent('data/cellar.json')` — throw `SyncError` if `null` (repo has no data).
2. Decode → parse → validate against schema (reuse `validate()`). Throw if invalid.
3. For each wine in pulled cellar with non-empty `photoRef`:
   `getFileContent('data/photos/<id>.avif')` → `savePhoto(id, blob)`.
4. Delete local photos for wines no longer in pulled cellar:
   load current local cellar, find wines whose IDs are gone or whose `photoRef`
   is now empty in the pulled version, call `deletePhoto(id)`.
5. `saveCellar(pulled cellar)` then `markSynced()` (markSynced resets the flag
   that saveCellar would have set — call them in order).
6. `cellarStore.set(pulled cellar)`.

> `saveCellar` sets `unsyncedStore = true` as a side effect. Call `markSynced()`
> immediately after to correct it; `markSynced` is the source of truth.

**New file:** `app/src/lib/data/sync.test.ts`

All tests mock `fetch` with `vi.stubGlobal`. Use `fake-indexeddb` for
IndexedDB-backed assertions.

| Test | What it verifies |
|------|-----------------|
| `push` PUTs `data/cellar.json` with correct base64 content | Core push |
| `push` PUTs each photo at `data/photos/<id>.avif` | Photo push |
| `push` includes SHA in PUT when file already exists on GitHub | Update path |
| `push` omits SHA when file does not exist (404 on GET) | Create path |
| `push` calls `markSynced` after success | Sync state reset |
| `push` throws `SyncError` when GitHub returns 401 | Auth error |
| `pull` downloads and applies `data/cellar.json` | Core pull |
| `pull` downloads and stores photos referenced in pulled cellar | Photo pull |
| `pull` deletes local photos for wines absent from pulled cellar | Cleanup |
| `pull` throws `SyncError('unsynced')` when local changes exist | Conflict guard |
| `pull` throws `SyncError` when `data/cellar.json` not on GitHub | Empty repo |
| `pull` throws when pulled cellar fails schema validation | Integrity guard |
| `forcePull` succeeds even when `unsyncedStore` is true | Force override |
| `markSynced` is called after successful pull | Sync state reset |

### 4. Settings route

**New file:** `app/src/routes/settings/+page.svelte`

- Back link (`← Dashboard`) at top.
- Repo field: text input, placeholder `owner/repo`.
- PAT field: `type="password"` input, placeholder `github_pat_…`.
- Save button: writes settings, navigates to dashboard.
- No "test connection" — keep it simple.

### 5. Dashboard sync controls

**Modify:** `app/src/routes/+page.svelte`

**Header changes:**
- Add gear icon (`⚙`) link to `/settings` in the header alongside the `+` button.

**`onMount` changes:**
- Also call `await loadSettings()` and read `unsyncedStore`.
- Listen to `online`/`offline` events: `let online = $state(navigator.onLine)`.

**Sync section (below the filter/sort bar):**

If `!isConfigured(settings)`:
```
[ Set up sync → ]
```

If `isConfigured(settings)`:
```
[ Push ]  [ Pull ]   ● synced / ○ unsynced changes / spinner
```

- Push button: calls `push(settings)`, shows "Pushing…" during operation;
  on error shows error message inline.
- Pull button: calls `pull(settings)`:
  - On `SyncError('unsynced')`: shows inline warning
    "Unsynced changes. Push first, or [Force-pull] to discard local changes."
    Force-pull button calls `forcePull(settings)` after a
    `confirm('This will discard all local changes. Continue?')`.
  - On other errors: shows error message.
- Both buttons disabled when `!online`.
- Spinner state: `let syncing = $state<'idle' | 'pushing' | 'pulling'>('idle')`.

---

## Files to create / modify

| File | Action |
|------|--------|
| `app/src/lib/data/settings.ts` | Create |
| `app/src/lib/data/settings.test.ts` | Create |
| `app/src/lib/data/sync.ts` | Create |
| `app/src/lib/data/sync.test.ts` | Create |
| `app/src/lib/data/persist.ts` | Modify (unsyncedStore, markSynced, loadSyncState) |
| `app/src/lib/data/store.ts` | Modify (call loadSyncState in initStore) |
| `app/src/routes/settings/+page.svelte` | Create |
| `app/src/routes/+page.svelte` | Modify (gear icon, sync controls) |
| `docs/roadmap.md` | Mark v0.4.0 complete |
| `CHANGELOG.md` | Add v0.4.0 entry |
| `app/package.json` | Bump to 0.4.0 |

---

## Verification

1. `npm test` in `app/` — all existing tests pass + new settings and sync tests pass.
2. `npm run lint && npm run format` — no errors.
3. `npm run build` — builds successfully.
4. Manual on iPhone:
   - [ ] Gear icon → Settings; enter real repo + PAT; save
   - [ ] Dashboard shows Push / Pull controls
   - [ ] Add a wine → Push → verify `data/cellar.json` appears on GitHub
   - [ ] Delete the wine locally → Push → verify GitHub is updated
   - [ ] On a second device (or after wiping IndexedDB): Pull → wine list restored
   - [ ] Edit wine locally → try Pull → see "unsynced changes" warning
   - [ ] Force-pull confirmation → local data overwritten
   - [ ] Turn off Wi-Fi → Push and Pull are disabled
